(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const m of s.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&i(m)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();const l=document.getElementById("playerSelect"),c=document.getElementById("dateSelect"),f=document.getElementById("durationInput"),E=document.getElementById("activitySelect"),u=document.getElementById("submitButton"),C=document.getElementById("status"),B=document.getElementById("suggestionCard"),D=document.getElementById("suggestionMessage"),O=document.getElementById("suggestionAcceptButton"),T=document.getElementById("suggestionCancelButton"),S=document.getElementById("celebration"),N=document.getElementById("celebrationMessage"),g=document.getElementById("celebrationGif"),H=u.textContent;let p=null;const r=["https://media.giphy.com/media/xT9IgG50Fb7Mi0prBC/giphy.gif","https://media.giphy.com/media/12XDYvMJNcmLgQ/giphy.gif","https://media.tenor.com/1mwdqr51emcAAAAd/happy-dance.gif","https://media.tenor.com/yCFHzEvKa9MAAAAC/party-time.gif","https://media.tenor.com/2roX3uxz_68AAAAC/cat-space.gif","https://media.tenor.com/5ry-200hErMAAAAC/happy-dance-cat.gif","https://media.tenor.com/3x63SNMKPogAAAAC/minions-celebrate.gif","https://media.tenor.com/uUNcnHwYJQEAAAAC/rick-roll.gif"],$=[{maxScore:5,gif:r[0]},{maxScore:10,gif:r[1]},{maxScore:15,gif:r[2]},{maxScore:20,gif:r[3]},{maxScore:25,gif:r[4]},{maxScore:30,gif:r[5]},{maxScore:1/0,gif:r[6]}],v=$[0].gif;let y=0;function _(e){if(!Number.isFinite(e))return v;const t=$.find(o=>e<=o.maxScore);return t?t.gif:v}g.addEventListener("error",()=>{y=(y+1)%r.length;const e=r[y];g.src!==e&&(g.src=e)});function a(e,t=""){C.textContent=e||"",C.classList.remove("error","success"),t&&C.classList.add(t)}function L(){p=null,B.classList.add("hidden"),D.textContent=""}function J({message:e,suggestedDate:t,payload:o}){p={suggestedDate:t,payload:o},D.textContent=`You already have a score for this date. Want to add this score to ${w(t)} instead?`,B.classList.remove("hidden")}function A(e){u.disabled=e,u.textContent=e?"Saving...":H,O.disabled=e,T.disabled=e}function h(){S.classList.add("hidden"),S.classList.remove("big"),N.textContent="",g.src=v,y=r.indexOf(v)}function Y({player:e,score:t}){const o=t==null||t===""?"(not ready yet)":t,i=Number(t),n=Number.isFinite(i)&&i>10,s=_(i);g.src=s,y=r.indexOf(s),S.classList.toggle("big",n),N.textContent=`Good job, ${e}! Your score is ${o}.`,S.classList.remove("hidden")}async function x(e,t={}){const o=await fetch(e,{headers:{"Content-Type":"application/json"},...t}),i=await o.text();let n={};if(i)try{n=JSON.parse(i)}catch{n={error:i}}if(!o.ok){const s=new Error(n.error||`Request failed (${o.status}).`);throw s.status=o.status,s.code=n.code,s.suggestion=n.suggestion,s}return n}function k(e){let t=[...c.options].find(o=>o.value===e);t||(t=document.createElement("option"),t.value=e,t.textContent=w(e),c.prepend(t)),c.value=e}function M(e){L(),a(`Saved for ${e.player} on ${e.date} (row ${e.row}).`,"success"),Y({player:e.player,score:e.score})}function I(e){return/^\d{1,3}:\d{2}$/.test(String(e).trim())}function b(){const e=l.value&&c.value&&I(f.value)&&E.value;u.disabled=!e}function G(e){const t=new Date(e);return t.setHours(0,0,0,0),t.toISOString().slice(0,10)}function w(e){const t=new Date(`${e}T00:00:00`);if(Number.isNaN(t.getTime()))return e;const o=t.toLocaleDateString(void 0,{weekday:"short"}),i=t.toLocaleDateString(void 0,{month:"short",day:"numeric"}),n=G(new Date);return e===n?`Today Â· ${o}, ${i}`:`${o}, ${i}`}function K(e){const t=[...new Set((e||[]).filter(Boolean))].sort((d,R)=>new Date(d).getTime()-new Date(R).getTime());if(!t.length)return{options:[],defaultDate:""};const o=G(new Date),i=t.filter(d=>d<=o),n=t.filter(d=>d>o),s=t.includes(o)?o:i[i.length-1]??t[0],m=i.slice(-5),P=n.slice(0,5),F=[s,...m.filter(d=>d!==s).reverse(),...P];return{options:[...new Set(F)].slice(0,10),defaultDate:s}}async function W(){a("Loading players..."),L(),h();const e=await x("/api/players"),t=await x("/api/dates?limit=90");l.innerHTML="",e.players.forEach((i,n)=>{const s=document.createElement("option");s.value=i.player,s.textContent=i.player,n===0&&(s.selected=!0),l.append(s)}),E.innerHTML="",e.activityOptions.forEach(i=>{const n=document.createElement("option");n.value=i,n.textContent=i,E.append(n)});const o=K(t.dates||[]);if(c.innerHTML="",o.options.forEach((i,n)=>{const s=document.createElement("option");s.value=i,s.textContent=w(i),(i===o.defaultDate||n===0)&&(s.selected=!0),c.append(s)}),!o.options.length){a("No existing date rows were found in the sheet.","error"),u.disabled=!0,l.disabled=!1,c.disabled=!0;return}l.disabled=!1,c.disabled=!1,u.disabled=!1,b(),a("Ready.")}async function q(){var t;L(),h();const e={player:l.value,date:c.value,duration:f.value.trim(),activity:E.value};if(!I(e.duration)){a("Duration must be in hh:mm format, for example 0:36.","error"),b();return}A(!0),a("Submitting...");try{const o=await x("/api/entry",{method:"POST",body:JSON.stringify(e)});M(o.result)}catch(o){o.code==="DATE_ALREADY_POPULATED"&&((t=o.suggestion)!=null&&t.date)?(J({message:o.message,suggestedDate:o.suggestion.date,payload:e}),a(""),h()):(a(o.message,"error"),h())}finally{A(!1),b()}}async function U(){if(!p)return;const e={...p.payload,date:p.suggestedDate};A(!0),a(`Submitting to ${w(e.date)}...`);try{const t=await x("/api/entry",{method:"POST",body:JSON.stringify(e)});k(e.date),M(t.result)}catch(t){a(t.message,"error"),h()}finally{A(!1),b()}}function j(){L(),a("Suggestion dismissed. Choose a different date to continue.","error")}[l,c,f,E].forEach(e=>{e.addEventListener("input",()=>{e===f&&f.value&&!I(f.value)?a("Duration should look like hh:mm, example 0:36."):a(""),b()})});u.addEventListener("click",q);O.addEventListener("click",U);T.addEventListener("click",j);W().catch(e=>{a(e.message,"error")});
